<div id="main-content">
  <div class="wrapper">

    <div class="filter-container">
      <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m...">

      <select id="brandFilter">
        <option value="">T·∫•t c·∫£ nh√£n hi·ªáu</option>
        {% for b in brands %}
        <option value="{{ b|lower }}">{{ b }}</option>
        {% endfor %}
      </select>

      <select id="priceFilter">
        <option value="">üí∞ T·∫•t c·∫£ gi√°</option>
        <option value="0-1000000">D∆∞·ªõi 1 tri·ªáu</option>
        <option value="1000000-5000000">1 ‚Äì 5 tri·ªáu</option>
        <option value="5000000-50000000">5 ‚Äì 50 tri·ªáu</option>
        <option value="50000000-">Tr√™n 50 tri·ªáu</option>
      </select>
    </div>

    <div class="product-grid" id="product-list">
      {% for p in products %}
      <div class="product-card"
           data-id="{{ p.id }}"
           data-name="{{ p.name|lower }}"
           data-category="{{ p.category|lower }}"
           data-brand="{{ p.brand|lower }}"
           data-price="{{ p.price }}">
        <img class="product-image" src="{{ p.image_url }}" alt="{{ p.name }}">
        <div class="product-name">{{ p.name }}</div>
        <div class="product-price">{{ "{:,}".format(p.price) }} VNƒê</div>
        <div class="product-category">Danh m·ª•c: {{ p.category }}</div>
        <div class="product-category">Nh√£n hi·ªáu: {{ p.brand }}</div>
      </div>
      {% endfor %}
    </div>

    <div id="pagination"></div>
  </div>

  <a href="/" class="back-link">‚Üê Quay v·ªÅ trang ch√≠nh</a>
</div>

<script>
  // H√†m ƒëi·ªÅu h∆∞·ªõng ƒë·∫øn trang chi ti·∫øt s·∫£n ph·∫©m theo id
  function goToDetail(productId) {
    window.location.href = `/product/${productId}`;
  }

  // L·∫•y c√°c ph·∫ßn t·ª≠ DOM c·∫ßn thi·∫øt
  const searchInput = document.getElementById('searchInput');
  const brandFilter = document.getElementById('brandFilter');
  const priceFilter = document.getElementById('priceFilter');
  const pagination = document.getElementById('pagination');

  const allCards = Array.from(document.querySelectorAll('.product-card'));
  let filteredCards = [...allCards];
  let currentPage = 1;
  const cardsPerPage = 25;

  // L·ªçc s·∫£n ph·∫©m theo keyword, brand, price
  function filterProducts() {
    const keyword = searchInput.value.toLowerCase().trim();
    const selectedBrand = brandFilter.value.toLowerCase().trim();
    const selectedPrice = priceFilter.value.trim();

    filteredCards = allCards.filter(card => {
      const name = card.dataset.name;
      const brand = card.dataset.brand;
      const price = parseInt(card.dataset.price);

      const matchKeyword = name.includes(keyword);
      const matchBrand = !selectedBrand || brand === selectedBrand;

      let matchPrice = true;
      if (selectedPrice) {
        const [minStr, maxStr] = selectedPrice.split("-");
        const min = parseInt(minStr || "0", 10);
        const max = maxStr ? parseInt(maxStr, 10) : Infinity;
        matchPrice = price >= min && price <= max;
      }

      return matchKeyword && matchBrand && matchPrice;
    });

    currentPage = 1;
    showCurrentPage();
    updatePagination();
  }

  // Hi·ªÉn th·ªã c√°c s·∫£n ph·∫©m c·ªßa trang hi·ªán t·∫°i
  function showCurrentPage() {
    allCards.forEach(card => card.style.display = "none");

    const start = (currentPage - 1) * cardsPerPage;
    const end = start + cardsPerPage;

    filteredCards.slice(start, end).forEach(card => {
      card.style.display = "flex";
    });

    attachCardClick();
  }

  // T·∫°o ph√¢n trang
  function updatePagination() {
    pagination.innerHTML = "";
    const totalPages = Math.ceil(filteredCards.length / cardsPerPage);
    if (totalPages <= 1) return;

    for (let i = 1; i <= totalPages; i++) {
      const btn = document.createElement("button");
      btn.textContent = i;
      if (i === currentPage) btn.classList.add("active");
      btn.addEventListener("click", () => {
        currentPage = i;
        showCurrentPage();
        updatePagination();
      });
      pagination.appendChild(btn);
    }
  }

  // G√°n s·ª± ki·ªán click cho c√°c th·∫ª s·∫£n ph·∫©m ƒëang hi·ªÉn th·ªã
  function attachCardClick() {
    filteredCards.forEach(card => {
      if (card.style.display !== "none") {
        card.onclick = () => {
          const id = card.dataset.id;
          goToDetail(id);
        };
      } else {
        card.onclick = null;
      }
    });
  }

  // G√°n s·ª± ki·ªán cho c√°c b·ªô l·ªçc
  searchInput.addEventListener('input', filterProducts);
  brandFilter.addEventListener('change', filterProducts);
  priceFilter.addEventListener('change', filterProducts);

  // Kh·ªüi ƒë·ªông l·∫ßn ƒë·∫ßu
  filterProducts();
</script>
